package automat;

import automat.Cell.CellActor;
import util.BitUtil;
import lime.app.Application;

import util.BitGrid;

import automat.actor.Actor;
import automat.actor.Shape;


import automat.Pos.xy as P;

class TestAutomat extends Application {


	public function new() {
		super();
		
		
		// -------- test Pos ----------
		/*
		trace(Pos.xMax, Pos.yMax);
		var p = new Pos(36,4);
		trace("pos:",p.x,p.y);
		p = Pos.xy(4,5);
		trace("pos:",p.x,p.y);
		
		trace("pos:", P(23, 42) );
		*/

		// -------- test cell ----------
		/*
		var c0 = new Cell(WATER,42);
		c0.actor = 5;
		trace(c0);
		trace("TYPE:", (c0.type:Int));
		trace("PARAM:",(c0.param:Int));
		trace("cell and type isSolid:", c0.isSolid, c0.type.isSolid);
		trace("cell and type isFluid:",c0.isFluid, c0.type.isFluid);
		trace("cell and type isGas:",c0.isGas, c0.type.isGas);
		*/


		/*
		// -------- test grid ----------
		var grid = new Grid();

		trace(Grid.WIDTH, Grid.HEIGHT);
		
		var c0 = new Cell(WATER,42);
		grid.set(new Pos(0,0), c0);
		grid.set(new Pos(0,1), 42);

		trace(grid.get(new Pos(0,0)));
		trace(grid.get(new Pos(0,1)));
		*/

		// -------- test BitGrid ----------
		/*
		var bitGrid:BitGrid = [
			"#  #  #   #",
			"#  #   # # ",
			"####    #  ",
			"#  #   # # ",
			"#  #  #   #",
		];		
		// bitGrid.set(0,0, false);
		// bitGrid.set(1,0);
		trace("\n"+bitGrid, bitGrid.width, bitGrid.height, bitGrid.hasGap());

		var bitGrid:BitGrid = "
			|                             |
			|   #  #   ##   #   #  ####   |
			|   #  #  #  #   # #   #      |
			|   ####  ####    #    ####   |
			|   #  #  #  #   # #   #      |
			|   #  #  #  #  #   #  ####   |
			|                             |
		";
		trace("\n"+bitGrid, bitGrid.width, bitGrid.height, bitGrid.hasGap());
		*/


		/*
		// -------- grid testdata ----------
		var grid = createTestGrid(TESTGRID);
		// trace(grid.get(new Pos(1,1)));

		grid.setAction(new Action(CELL_MOVE, new Pos(1,1)), 0); // immediadly
		grid.setAction(new Action(CELL_EMPTY, new Pos(3,4)), Grid.MAX_STEPS-1); // max delay time 

		// simmulate 10 timesteps
		for (i in 0...10) {
			trace('step $i');
			grid.step();
		}
		*/


		// -------- add/remove Actors ----------

		var grid = createTestGrid(TESTGRID);
		
		var actor = new Actor("Alice");
		trace("is free:", actor.isFitIntoGrid(grid, P(1,1) ) );

		actor.addToGrid(grid, P(1,1));
		trace("isFreeLeft",actor.isFreeLeft());
		

		var actor = new Actor("Bob");
		trace("is free:", actor.isFitIntoGrid(grid, P(3,2) ) );

		actor.addToGrid(grid, P(3,2));
		trace("isFreeLeft",actor.isFreeLeft());
		// traceGrid(grid);



		// TODO:
		// actor.removeFromGrid();

		trace("Grid.WIDTH " + Grid.WIDTH,"Grid.HEIGHT " + Grid.HEIGHT);
		trace("CellActor.MAX_ACTORS " + CellActor.MAX_ACTORS,"CellActor.bits " + CellActor.bits);

		


		/*
		// -------- benchmarks -------------
		var t = haxe.Timer.stamp();
		var i:Int = 0;
		while (i < 1000000) {
			var actor = grid.getActor( new Pos(Std.random(64),Std.random(64)) );
			if ((actor:Int) < 132) actor++;
			grid.setActor( new Pos(Std.random(64),Std.random(64)) , actor );
			i+=1;
		}
		trace( (haxe.Timer.stamp() - t) );
		*/

	}


	// ----------------------------------------------------------------
	// ----------------------------------------------------------------
	// ----------------------------------------------------------------

	public static function traceGrid(grid:Grid) {
		var s = "\n";
		for (y in 0...Grid.HEIGHT) {
			for (x in 0...Grid.WIDTH) {
				var cell = grid.get(P(x,y));
				if (cell.hasActor) s += cell.actor;
				else {
					s += switch(cell.type) {
						case AIR: ".";
						case METAL: "#";
						case EARTH: "E";
						case ROCK: "R";
						case WATER: "^";
						case MILK: "m";
						case PISS: "p";
						default: " ";
					}
				}
			}
			s += "\n";
		}
		trace(s);
	}
	
	public static function createTestGrid(testGrid:String):Grid {
		var grid = new Grid();

		testGrid = ~/\n+/g.replace(testGrid, "");

		for (i in 0...testGrid.length) {
			var c = testGrid.charAt(i);
			switch (c) {
				case ".": grid.set( i, new Cell(AIR) );
				case "#": grid.set( i, new Cell(METAL) );
				case "E": grid.set( i, new Cell(EARTH) );
				case "R": grid.set( i, new Cell(ROCK) );
				case "^": grid.set( i, new Cell(WATER)  );
				case "m": grid.set( i, new Cell(MILK)  );
				case "p": grid.set( i, new Cell(PISS)  );
				// TODO:
				// case "P": // grid.set( i, new Cell(AIR, new Actor(PLAYER) ));

				default: throw('unknown "$c" in TESTGRID');
			}
		}

		return grid;
	}

	public static inline var TESTGRID:String =
"
################################################################
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..EEEE....EEEEEE..............................................#
#...................................E^^^^E.....................#
#.................RR................E^^^^E.....................#
#..................RR...............E^^^^E.....................#
#...................R...............E^^^^E.....................#
#...................RRR.............E^^^^E.....................#
#...................RRRRREEEEEEEEEEEEEEEEE.....................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
#..............................................................#
################################################################
";

}
